name: Windows 11 RDP with Ngrok

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest  # closest official Windows runner available
    timeout-minutes: 9999

    steps:
      - name: ğŸ§¾ Download Dependencies
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Invoke-WebRequest https://raw.githubusercontent.com/Riders004/rdp/master/start.bat -OutFile start.bat
          Invoke-WebRequest https://raw.githubusercontent.com/Riders004/rdp/master/download1.jpeg -OutFile wallpaper.bat
          Invoke-WebRequest https://raw.githubusercontent.com/Vip3rLi0n/Ngrok-RDPs/main/resources/loop.ps1 -OutFile loop.ps1

      - name: ğŸ“¦ Extract Ngrok
        run: Expand-Archive ngrok.zip

      - name: ğŸ” Authenticate Ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ./ngrok/ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN

      - name: ğŸªŸ Enable RDP on Windows
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          Copy-Item wallpaper.bat D:\a\wallpaper.bat

      - name: ğŸš€ Start Ngrok Tunnel for RDP (3389)
        run: |
          Start-Process -FilePath "./ngrok/ngrok.exe" -ArgumentList "tcp 3389" -RedirectStandardOutput "D:\a\ngrok.log"
          Start-Sleep -Seconds 15

      - name: ğŸŒ Show Public RDP Address
        run: |
          $logPath = "D:\a\ngrok.log"
          if (-Not (Test-Path $logPath)) {
            Write-Output "âŒ ngrok.log was not found. Ngrok may have failed to start."
            exit 1
          }
          $log = Get-Content $logPath -Raw
          if ($log -match "url=tcp://([a-zA-Z0-9\.-]+):([0-9]+)") {
            $host = $matches[1]
            $port = $matches[2]
            Write-Output "`nğŸ”— RDP Login Address: ${host}:${port}`n"
          } else {
            Write-Output "âŒ Could not extract Ngrok tunnel URL. Dumping log:"
            Write-Output "`n--- NGROK LOG START ---`n"
            Get-Content $logPath
            Write-Output "`n--- NGROK LOG END ---`n"
            exit 1
          }

      - name: ğŸ§‘â€ğŸ’» Set RDP User & Password
        run: |
          net user administrator OLDUSER#6
          Write-Output "`nğŸ‘¤ Username: administrator"
          Write-Output "ğŸ”‘ Password: OLDUSER#6"

      - name: â–¶ï¸ Run RDP Setup Script
        run: cmd /c start.bat

      - name: ğŸ” Run Loop Script (Keep RDP Alive)
        run: powershell -ExecutionPolicy Bypass -File loop.ps1
